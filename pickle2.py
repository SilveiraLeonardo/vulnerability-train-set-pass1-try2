
from __future__ import unicode_literals
from flask import Flask, request, make_response, redirect, url_for, session
from flask import render_template, flash, redirect, url_for, request
from werkzeug.security import safe_str_cmp
from base64 import b64decode as b64d
from base64 import b64encode as b64e
from hashlib import sha256
from io import StringIO
import json
import random
import string

import os
import sys
import itsdangerous

SECRET_KEY = 'you will never guess'

if not os.path.exists('.secret'):
    with open(".secret", "wb") as f:
        secret = os.urandom(32)
        f.write(secret)
with open(".secret", "rb") as f:
    cookie_secret = f.read()

serializer = itsdangerous.URLSafeSerializer(cookie_secret)

app = Flask(__name__)
app.config.from_object(__name__)

@app.before_request
def count():
    session['cnt'] = 0

@app.route('/')
def home():
    remembered_str = "Hello, here's what we remember for you. And you can change, delete or extend it."
    new_str = 'Hello fellow zombie, have you found a tasty brain and want to remember where? Go right here and enter it:'
    location = getlocation()
    if location == False:
        return redirect(url_for("clear"))
    return render_template('index.html', txt=remembered_str, location=location)

@app.route('/clear')
def clear():
    flash("Reminder cleared!")
    response = redirect(url_for('home'))
    response.set_cookie('location', max_age=0)
    return response

@app.route('/reminder', methods=['POST', 'GET'])
def reminder():
    if request.method == 'POST':
        location = request.form["reminder"]
        if location == '':
            flash("Message cleared, tell us when you have found more brains.")
        else:
            flash("We will remember where you find your brains.")
        location = b64e(json.dumps(location).encode())
        cookie = make_cookie(location, cookie_secret)
        response = redirect(url_for('home'))
        response.set_cookie('location', cookie)
        return response
    location = getlocation()
    if location == False:
        return redirect(url_for("clear"))
    return render_template('reminder.html')

def getlocation():
    cookie = request.cookies.get('location')
    if not cookie:
        return ''
    (digest, location) = cookie.split("!")
    if not safe_str_cmp(calc_digest(location, cookie_secret), digest):
        flash("Hey! This is not a valid cookie! Leave me alone.")
        return False
    location = json.loads(b64d(location))
    return location

def make_cookie(location, secret):
    return "%s!%s" % (calc_digest(location, secret), location)

def calc_digest(location, secret):
    return sha256("%s%s".encode() % (location, secret)).hexdigest()

if __name__ == '__main__':
    app.run(host="0.0.0.0", port=5051)
