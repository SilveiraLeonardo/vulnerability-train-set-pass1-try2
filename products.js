
const config = require("../config"),
    pgp = require('pg-promise')(),
    db = pgp(config.db.connectionString);

function list_products() {
    const q = "SELECT * FROM products;";
    return db.many(q);
}

function getProduct(product_id) {
    const q = pgp.as.format("SELECT * FROM products WHERE id = $1;", [product_id]);
    return db.one(q);
}

function search(query) {
    const searchPattern = '%' + query + '%';
    const q = pgp.as.format("SELECT * FROM products WHERE name ILIKE $1 OR description ILIKE $1;", [searchPattern]);
    return db.many(q);
}

function purchase(cart) {
    const values = [
        cart.mail,
        cart.product_name,
        cart.username,
        cart.product_id,
        cart.address,
        cart.ship_date,
        cart.phone,
        cart.price
    ];
    const q = pgp.as.format(`INSERT INTO purchases(mail, product_name, user_name, product_id, address, phone, ship_date, price) 
                             VALUES($1, $2, $3, $4, $5, $6, $7, $8);`, values);
    return db.one(q);
}

function get_purcharsed(username) {
    const q = pgp.as.format("SELECT * FROM purchases WHERE user_name = $1;", [username]);
    return db.many(q);
}

const actions = {
    "list": list_products,
    "getProduct": getProduct,
    "search": search,
    "purchase": purchase,
    "getPurchased": get_purcharsed
}

module.exports = actions;
