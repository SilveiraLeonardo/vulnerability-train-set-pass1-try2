
<?php
include("../common/header.php");
hint("not everything you need to inject is in a text input field ...");
?>

<form action="/CMD-6/index.php" method="POST">
    <input type="text" name="domain">
    <input type="submit" value="Submit">
</form>

<pre>
<?php
// Validate domain name
function validateDomain($domain)
{
    if (strlen($domain) > 253) {
        return false;
    }

    return preg_match('/^[-a-z0-9]{1,63}(\.[-a-z0-9]{2,63})+(\.[a-z]{2,})$/i', $domain);
}

function whoisLookup($domain)
{
    $stream = stream_socket_client('udp://whois.publicinterestregistry.net:43', $errno, $errstr, 10);

    if (!$stream) {
        echo "Failed to contact server. Error: $errstr ($errno)";
        return;
    }

    fwrite($stream, $domain . "\r\n");
    $response = '';
    while (!feof($stream)) {
        $response .= fread($stream, 4096);
    }

    fclose($stream);

    return $response;
}

if (isset($_POST["domain"]) && validateDomain($_POST["domain"])) {
    $sanitizedDomain = htmlspecialchars($_POST["domain"]);
    $response = whoisLookup($sanitizedDomain);
    echo htmlentities($response, ENT_QUOTES, 'UTF-8');
} else {
    echo "malformed domain name";
}
?>
</pre>
