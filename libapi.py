
import libuser
import hashlib
import secrets
from pathlib import Path

keys_storage = {}  # Replace this with a secure database or storage mechanism


def keygen(username, password=None):

    if password:
        if not libuser.login(username, password):
            return None

    key = secrets.token_hex(64)  # 64 bytes or 512 bits

    if username in keys_storage:  # Remove previous key
        del keys_storage[username]

    keys_storage[username] = key

    return key


def authenticate(request):
    if 'X-APIKEY' not in request.headers:
        return None

    key = request.headers['X-APIKEY']

    for username, stored_key in keys_storage.items():
        if stored_key == key:
            return username

    return None
