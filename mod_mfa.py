
import base64
import re
from functools import wraps
from io import BytesIO

import pyotp
import qrcode
from flask import Blueprint, flash, g, redirect, render_template, request

import libmfa

mod_mfa = Blueprint('mod_mfa', __name__, template_folder='templates')


def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'username' not in g.session:
            return redirect('/user/login')
        return f(*args, **kwargs)
    return decorated_function


@mod_mfa.route('/', methods=['GET'])
@login_required
def do_mfa_view():
    if libmfa.mfa_is_enabled(g.session['username']):
        return render_template('mfa.disable.html')
    else:
        libmfa.mfa_reset_secret(g.session['username'])
        secret = libmfa.mfa_get_secret(g.session['username'])
        secret_url = pyotp.totp.TOTP(secret).provisioning_uri(g.session['username'], issuer_name="Vulpy")
        img = qrcode.make(secret_url)

        buffered = BytesIO()
        img.save(buffered, format="PNG")
        img_str = base64.b64encode(buffered.getvalue()).decode()

        return render_template('mfa.enable.html', secret_url=secret_url, img_str=img_str)


@mod_mfa.route('/', methods=['POST'])
@login_required
def do_mfa_enable():
    secret = libmfa.mfa_get_secret(g.session['username'])

    otp = request.form.get('otp')

    if not re.match('^[0-9]{6}$', otp):
        flash("Invalid OTP format")
        return redirect('/mfa/')

    totp = pyotp.TOTP(secret)

    if totp.verify(otp):
        libmfa.mfa_enable(g.session['username'])
        return redirect('/mfa/')
    else:
        flash("The OTP was incorrect")
        return redirect('/mfa/')

    return render_template('mfa.enable.html')


@mod_mfa.route('/disable', methods=['GET'])
@login_required
def do_mfa_disable():
    libmfa.mfa_disable(g.session['username'])
    return redirect('/mfa/')
